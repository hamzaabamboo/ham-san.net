---
//TODO:
import { FaArrowLeft } from 'react-icons/fa';
import { Box, Container, Divider, HStack, Stack, Wrap, styled } from 'styled-system/jsx';
import { formatMonthYear, parseDate } from 'utils/date';
import { getMediaUrl } from 'utils/media';
import { Carousel } from '~/components/common/Carousel';
import { LinkItem } from '~/components/common/LinkItem';
import { Markdown } from '~/components/lib/Markdown';
import { TagBadge } from '~/components/tags/TagBadge';
import { Heading } from '~/components/ui/heading';
import { Link } from '~/components/ui/link';
import { Text } from '~/components/ui/text';
import { graphQLSdk } from '~/graphql';
import { toLegacyGetProjectBySlug } from '~/graphql/legacy';
import { ComponentUtilsLink, Tag } from '~/graphql/generated/client';
import { useTranslations, validateLocale } from '~/i18n/utils';
import MainLayout from '~/layouts/MainLayout.astro';

export const prerender = false;

const { locale, slug } = Astro.params;

const data = toLegacyGetProjectBySlug(
  await graphQLSdk.getProjectBySlug({
  slug
})
);

if (!validateLocale(locale)) {
  return Astro.redirect('/404');
}

type LegacyMedia = { data?: { attributes?: { url?: string; name?: string } | null } | null };
type LegacyTagCollection = { data?: Array<{ attributes?: Tag | null }> };
type LegacyProject = {
  content?: string;
  title?: string;
  banner?: LegacyMedia;
  links?: Array<ComponentUtilsLink | null | undefined>;
  media?: { data?: Array<{ attributes?: { url?: string } | null }> };
  category?: { data?: { attributes?: { name?: string } | null } | null };
  date?: string;
  finishedDate?: string;
  tags?: LegacyTagCollection;
};
const project = (data?.projects?.data?.[0]?.attributes ?? {}) as LegacyProject;
const { content, title, banner, links, media, category, date, finishedDate, tags } = project;
const { url: bannerPath, name: bannerName } = banner?.data?.attributes ?? {};
const bannerUrl = getMediaUrl(bannerPath, {}, import.meta.env.PUBLIC_API_URL);
const mediaItems = (media?.data ?? []) as Array<{ attributes?: { url?: string } }>;
const images = mediaItems
  .map((d) => getMediaUrl(d.attributes?.url, {}, import.meta.env.PUBLIC_API_URL))
  .filter((d): d is string => !!d);
const tagItems = (tags?.data ?? []) as Array<{ attributes?: Tag }>;
const linkItems = (links ?? []) as Array<ComponentUtilsLink | null | undefined>;
const t = useTranslations(locale);

Astro.response.headers.set('CDN-Cache-Control', 'public, max-age=86400, must-revalidate');
---

<MainLayout>
  <Container maxW="breakpoint-xl" py="8" w="full">
    <Stack gap="4">
      <Link href={`/${locale}/projects`}>
        <Wrap fontSize="sm" alignItems="center">
          <FaArrowLeft />
          <Text>{t('project.back-to-projects')}</Text>
        </Wrap>
      </Link>
      {
        bannerUrl && (
          <Box rounded="l1" overflow="hidden">
            <styled.img
              src={bannerUrl}
              alt={bannerName ?? title ?? undefined}
              objectFit="contain"
              objectPosition="center"
              width="full"
              aspectRatio="16 / 9"
              backgroundColor="bg.muted"
              style={{
                viewTransitionName: `project-image-${slug}`
              }}
            />
          </Box>
        )
      }
      <Stack gap="2">
        <Stack gap="1">
          <Heading
            as="h1"
            size="2xl"
            fontWeight="bold"
            style={{
              viewTransitionName: `project-title-${slug}`
            }}>{title}</Heading
          >
          <Wrap fontSize="md" color="fg.subtle">
            <Text>{category?.data?.attributes?.name}</Text>
            <Text>|</Text>
            <Text>
              {formatMonthYear(parseDate(date as string), locale)} -{' '}
              {
                finishedDate
                  ? formatMonthYear(parseDate(finishedDate as string), locale)
                  : t('common.present')
              }
            </Text>
          </Wrap>
        </Stack>
        {
          tags && (
            <HStack>
              <Text>{t('common.tags')}</Text>
              <Wrap>
                {tagItems
                  .filter((t) => !!t)
                  .map((t) => (
                    <Link href={`/${locale}/tags/${t.attributes?.slug}`}>
                      <TagBadge tag={t.attributes as Tag} showCount size="sm" />
                    </Link>
                  ))}
              </Wrap>
            </HStack>
          )
        }
        {
          links && (
            <Stack gap="1">
              {linkItems
                .filter((l): l is ComponentUtilsLink => !!l)
                .map((l) => {
                  return <LinkItem data={l} />;
                })}
            </Stack>
          )
        }
      </Stack>

      <Divider />
      {content && <Markdown content={content} assetsPrefix={import.meta.env.PUBLIC_API_URL} />}
      {
        images.length > 0 && (
          <Stack gap="4">
            <Heading as="h2" size="xl" fontWeight="bold">
              {t('project.screenshots')}
            </Heading>
            <Carousel client:visible images={images} />
          </Stack>
        )
      }
    </Stack>
  </Container>
</MainLayout>
